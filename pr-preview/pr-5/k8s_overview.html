<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>k8s overview and architecture - k8s the hard(er) way</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="prerequisites.html">Prerequisites</a></li><li class="chapter-item expanded affix "><a href="k8s_overview.html" class="active">k8s overview and architecture</a></li><li class="chapter-item expanded affix "><li class="part-title">Guide</li><li class="chapter-item expanded "><a href="chapter_0.html"><strong aria-hidden="true">1.</strong> Chapter 0</a></li><li class="chapter-item expanded affix "><li class="part-title">Appendix</li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">k8s the hard(er) way</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="kubernetes-overview-brain-dump"><a class="header" href="#kubernetes-overview-brain-dump">Kubernetes Overview (Brain Dump)</a></h1>
<p>If you are arriving here and you don't know....</p>
<ul>
<li>what kubernetes is... <a href="https://kubernetes.io/docs/concepts/overview/">read this</a></li>
<li>what the k8s control plane is... <a href="https://kubernetes.io/docs/concepts/overview/components/">read this</a></li>
</ul>
<p>We'll unpack these concepts in much more detail as we go on, but we need to establish some baseline of knowledge, and no need to recreate the wheel here.</p>
<h2 id="the-beginning"><a class="header" href="#the-beginning">The Beginning</a></h2>
<p><img src="https://d33wubrfki0l68.cloudfront.net/2475489eaf20163ec0f54ddc1d92aa8d4c87c96b/e7c81/images/docs/components-of-kubernetes.svg" alt="k8s official overview diagram" /></p>
<p>When people refer to a &quot;kubernetes cluster&quot; they tend to be referring to the capability of running a container workload in the cloud. That speaks to an outcome and not really the &quot;well, what is it?&quot; question -- and at its core a k8s cluster is the union of two distinct logical parts: a control plane responsible for managing the system, and a fleet (as small as 1) of &quot;worker&quot; nodes that can actually run container* workloads. (TODO: why &quot;container&quot; is in quotes -- reference various runtimes)</p>
<p>In &quot;managed kubernetes environments&quot; -- e.g. AWS Elastic Kubernetes Service (EKS), Google's GKE (Google Kubernentes Engine), Azure's AKS (Azure Kubernetes Service) -- the cloud provider tends to run the contorl plane on a user's behalf, and its completely hidden away as an implementation detail. One of the major purposes of this project is to dive head-on into the control plane, so we won't be waving any hands here.</p>
<p>Essentially the cloud provider agrees to operate the control plane and the customer uses the cloud provider's other services -- compute, storage, load balancers, container registries -- to power the fleet of worker nodes (and of course, make money off the use of those resources). We won't get too much into the financials but you can see why some cloud providers don't even charge for their &quot;managed k8s&quot; service -- while they expend some resource behind the scenes on the machinery that makes up the control plane, they anticipate users will spend money on the resources needed to actually make up the &quot;worker&quot; plane since it is these workers that actually <em>run</em> user applicaitons (aka workloads).</p>
<p>Now, in reality different providers have different commercial setups. Some charge for the control plane, others make it available for free but charge to make it &quot;highly available&quot;, or charge for other features like logging... there is a spectrum. But the general idea is this: the cloud provider provides the control plane &quot;as a service&quot; (i.e. out of your direct, full control) and the user pays for a worker node fleet... and the two combine to create a &quot;cluster&quot;.</p>
<h2 id="so-what-is-the-control-plane"><a class="header" href="#so-what-is-the-control-plane">So what is the control plane?</a></h2>
<p>Well, thats a tough question. At the end of the day its the &quot;command and control&quot; infrastructure needed to actually run container workloads... It gets told to run container workloads or open ports on containers or fetch logs, passes those commands on to other folk who do the hard work, and then handles the answer.</p>
<p>...But that doesn't really help clarify things at all.</p>
<p>Often times control plane explanations begin with a discussion of control loops... we'll be lazy and do the same.</p>
<blockquote>
In robotics and automation, a control loop is a non-terminating loop that regulates the state of a system.
<p>Here is one example of a control loop: a thermostat in a room.</p>
<p>When you set the temperature, that's telling the thermostat about your desired state. The actual room temperature is the current state. The thermostat acts to bring the current state closer to the desired state, by turning equipment on or off.</p>
<p>In Kubernetes, controllers are control loops that watch the state of your cluster, then make or request changes where needed. Each controller tries to move the current cluster state closer to the desired state.</p>
<p><a href="https://kubernetes.io/docs/concepts/architecture/controller/">Source</a></p>
</blockquote>
<p>Which is a pretty good mental model to start with but kind of lacks the <em>oomph</em> we need to really understand what the contol plane does.</p>
<p>Let's start with a small slice of the pie -- tracing through what happens when we kubernetes to run a &quot;container&quot; (pod) -- as an entrypoint to understanding the responsibilities of the control plane and how it works.</p>
<h3 id="launching-a-pod-level-0-the-surface-of-the-onion"><a class="header" href="#launching-a-pod-level-0-the-surface-of-the-onion">Launching a pod: Level 0: The surface of the onion</a></h3>
<p>If you don't know what a pod is... read the <a href="https://kubernetes.io/docs/concepts/workloads/pods/">k8s pod intro</a></p>
<p>We'll go through this piece by piece, starting with a gross oversimplication and then slowly unpacking layers like an onion until we have a better sketch of what the control plane does.</p>
<p>So: I want to run an HTTP server serving a basic static website with the most bare-bones of &quot;Hello World&quot; index html file. Nginx is fine, so lets have it be nginx.</p>
<p><img src="mdbook-plantuml-img/7cba6361400156e0c5e68f991f278fc346aca32b.svg" alt="" /></p>
<p>Alright, so that seems logical enough. Lets unpack it a bit.</p>
<p><strong>The User</strong> in this basic example is someone invoking an RPC (remote command invocation) call against an API server being run as part of the control plane. How that RPC call might take several manifestations but at its most basic it can be an HTTP request where the body contains the intent to run nginx. It might look like the below:</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
</code></pre>
<p>And it really is that simple. If I were to run <code>kubectl apply -f - &lt;&lt;&lt;&quot;CONTENTES FROM ABOVE&quot;</code>, <code>kubectl</code> simply takes my user input, validates it, looks up the details of the API server like its host and port, looks up some credentials, and then packages the YAML up into a pretty little HTTP request and sends it along to the remote server (perhaps with a sprinking of credentials). The &quot;control plane API server&quot; validates the permissions of the user making the HTTP request, validates the payload matches the expected schema for a &quot;create deployment&quot; request, and, if all looks good, continues on in the sequence as we drew it above.</p>
<p>I mean the emperor wears no clothes here, see for yourself:</p>
<pre><code class="language-bash">❯ kubectl apply -f output/nginx.deployment.yaml --v=8
I0929 15:15:17.887777   37013 loader.go:374] Config loaded from file:  /Users/jroberts/repos/personal/k8s-the-harder-way/output/kube-configs/admin.kubeconfig
I0929 15:15:17.888660   37013 round_trippers.go:463] GET https://127.0.0.1:6443/openapi/v2?timeout=32s
I0929 15:15:17.888668   37013 round_trippers.go:469] Request Headers:
I0929 15:15:17.888673   37013 round_trippers.go:473]     User-Agent: kubectl/v1.25.0 (darwin/arm64) kubernetes/a866cbe
I0929 15:15:17.888676   37013 round_trippers.go:473]     Accept: application/com.github.proto-openapi.spec.v2@v1.0+protobuf
I0929 15:15:17.903929   37013 round_trippers.go:574] Response Status: 200 OK in 15 milliseconds
I0929 15:15:17.903944   37013 round_trippers.go:577] Response Headers:
I0929 15:15:17.903948   37013 round_trippers.go:580]     Date: Thu, 29 Sep 2022 22:15:17 GMT
I0929 15:15:17.903951   37013 round_trippers.go:580]     Etag: &quot;9DB40C853CA3ADDD649055A9853FE28D1264FAEE1DBFA41212431A2A7B89BAC87C7E2059BAEC006DA5856A114731A4658CCA9BFFCB82FEB3B45304C9D8237EBB&quot;
I0929 15:15:17.903955   37013 round_trippers.go:580]     X-Kubernetes-Pf-Prioritylevel-Uid: 5dfa948e-cd85-4716-9e5e-60b0081f1d1e
[...TRUNCATED...]
I0929 15:15:17.990891   37013 round_trippers.go:463] POST https://127.0.0.1:6443/apis/apps/v1/namespaces/default/deployments?fieldManager=kubectl-client-side-apply&amp;fieldValidation=Strict
I0929 15:15:17.990897   37013 round_trippers.go:469] Request Headers:
I0929 15:15:17.990901   37013 round_trippers.go:473]     Accept: application/json
I0929 15:15:17.990904   37013 round_trippers.go:473]     Content-Type: application/json
I0929 15:15:17.990908   37013 round_trippers.go:473]     User-Agent: kubectl/v1.25.0 (darwin/arm64) kubernetes/a866cbe
I0929 15:15:18.004996   37013 round_trippers.go:574] Response Status: 201 Created in 14 milliseconds
I0929 15:15:18.005028   37013 round_trippers.go:577] Response Headers:
I0929 15:15:18.005039   37013 round_trippers.go:580]     Cache-Control: no-cache, private
I0929 15:15:18.005048   37013 round_trippers.go:580]     Content-Type: application/json
I0929 15:15:18.005058   37013 round_trippers.go:580]     X-Kubernetes-Pf-Flowschema-Uid: 83eb73fc-81b4-435a-b45a-8d28a44a3f08
I0929 15:15:18.005067   37013 round_trippers.go:580]     X-Kubernetes-Pf-Prioritylevel-Uid: 5dfa948e-cd85-4716-9e5e-60b0081f1d1e
I0929 15:15:18.005075   37013 round_trippers.go:580]     Content-Length: 2392
I0929 15:15:18.005084   37013 round_trippers.go:580]     Date: Thu, 29 Sep 2022 22:15:18 GMT
I0929 15:15:18.005145   37013 request.go:1073] Response Body: {&quot;kind&quot;:&quot;Deployment&quot;,&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;metadata&quot;:{&quot;name&quot;:&quot;nginx&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;4599327e-a8fc-4eb0-9dfd-ac4be1ef3f0d&quot;,&quot;resourceVersion&quot;:&quot;3173&quot;,&quot;generation&quot;:1,&quot;creationTimestamp&quot;:&quot;2022-09-29T22:15:17Z&quot;,&quot;labels&quot;:{&quot;app&quot;:&quot;nginx&quot;},&quot;annotations&quot;:{&quot;kubectl.kubernetes.io/last-applied-configuration&quot;:&quot;{\&quot;apiVersion\&quot;:\&quot;apps/v1\&quot;,\&quot;kind\&quot;:\&quot;Deployment\&quot;,\&quot;metadata\&quot;:{\&quot;annotations\&quot;:{},\&quot;labels\&quot;:{\&quot;app\&quot;:\&quot;nginx\&quot;},\&quot;name\&quot;:\&quot;nginx\&quot;,\&quot;namespace\&quot;:\&quot;default\&quot;},\&quot;spec\&quot;:{\&quot;replicas\&quot;:1,\&quot;selector\&quot;:{\&quot;matchLabels\&quot;:{\&quot;app\&quot;:\&quot;nginx\&quot;}},\&quot;template\&quot;:{\&quot;metadata\&quot;:{\&quot;labels\&quot;:{\&quot;app\&quot;:\&quot;nginx\&quot;}},\&quot;spec\&quot;:{\&quot;containers\&quot;:[{\&quot;image\&quot;:\&quot;nginx:1.14.2\&quot;,\&quot;name\&quot;:\&quot;nginx\&quot;,\&quot;ports\&quot;:[{\&quot;containerPort\&quot;:80}]}]}}}}\n&quot;},&quot;managedFields&quot;:[{&quot;manager&quot;:&quot;kubectl-client-side-apply&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;time&quot;:&quot;2022-09-29T22:15:17Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:{&quot;f:metadata&quot;:{&quot;f:annotations&quot;:{&quot;.&quot;:{},&quot;f:kubectl.kubernetes.io/last-applied-configuration&quot;:{}},&quot;f:labels&quot;:{&quot;.&quot;:{},&quot;f:app&quot;:{}}},&quot;f [truncated 1368 chars]
deployment.apps/nginx created
I0929 15:15:18.005711   37013 apply.go:466] Running apply post-processor function`
</code></pre>
<p>Sure there was a little back and forth in the beginning related to validation (<code>kubectl</code> by default actually tries to apply client-side validation by first looking up the OpenAPI scheme associated with the API server it going to send the request to eventually, which can be turned off with the <code>--validate='ignore'</code>). But do you see the line <code>POST https://127.0.0.1:6443/apis/apps/v1/namespaces/default/deployments?fieldManager=kubectl-client-side-apply&amp;fieldValidation=Strict</code>? Pretty much did what I told you. (Note, this is actually a lie, but its a white lie... if we set <code>--server-side=true</code> it wouldn't be though).</p>
<p><em>TODO: Add a page on kubectl and client-side application and validation</em></p>
<h3 id="launching-a-pod-level-1-unpacking-the-components-on-the-control-plane"><a class="header" href="#launching-a-pod-level-1-unpacking-the-components-on-the-control-plane">Launching a pod: Level 1: Unpacking the components on the control plane</a></h3>
<p>So pretty conveniently in the above sequence diagram we just draw a box for the &quot;control plane&quot; actor up at the top. But the control plane isn't just this API server thing we alluded to in the prior section. Its actually a few different components all working together that create the apparition we call the &quot;control plane&quot;.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="prerequisites.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="chapter_0.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="prerequisites.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="chapter_0.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
